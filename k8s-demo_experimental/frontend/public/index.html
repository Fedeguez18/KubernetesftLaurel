<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>K8s Demo - Frontend</title>
    <style>
      /* (mismo estilo base que tenías) */
      /* Para no repetir todo, conservé tu CSS original. */
      body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0c2340 0%, #1a3a5c 50%, #2c5282 100%); min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: flex-start; }
      .container { background: rgba(255,255,255,0.98); border-radius:24px; padding:40px; max-width:900px; width:100%; }
      .row { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
      input, select, button { padding:10px; border-radius:8px; border:1px solid #ddd; }
      .hidden { display:none; }
      table { width:100%; border-collapse:collapse; margin-top:12px; }
      td, th { padding:8px; border-bottom:1px solid #eee; text-align:left; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Kubernetes Demo — Sistema de Asistencia</h1>
      <p id="status">Cargando...</p>

      <div id="authSection">
        <div class="row">
          <input id="username" placeholder="usuario" />
          <input id="password" type="password" placeholder="contraseña" />
          <button id="loginBtn">Iniciar sesión</button>
          <button id="logoutBtn" class="hidden">Cerrar sesión</button>
        </div>
        <div>
          <small>Usuarios de prueba: admin/adminpass, prof1/teacherpass, student1/studentpass</small>
        </div>
      </div>

      <div id="userInfo" class="row hidden">
        <strong>Usuario:</strong> <span id="meUser"></span>
        <strong style="margin-left:12px;">Rol:</strong> <span id="meRole"></span>
      </div>

      <hr />

      <!-- Management (visible a teacher/admin) -->
      <div id="management" class="hidden">
        <h2>Administración</h2>
        <div class="row">
          <input id="studentName" placeholder="Nombre del alumno" />
          <button id="addStudentBtn">Crear alumno</button>
        </div>
        <div class="row">
          <input id="courseName" placeholder="Nombre del curso" />
          <button id="addCourseBtn">Crear curso</button>
        </div>
        <div id="studentsList"></div>
        <div id="coursesList"></div>
      </div>

      <!-- Attendance UI -->
      <div id="attendanceSection" class="hidden">
        <h2>Marcar/Ver Asistencia</h2>

        <div class="row" id="teacherAttendanceControls">
          <select id="selectCourse"></select>
          <input type="date" id="attendanceDate" />
          <button id="loadStudentsBtn">Cargar alumnos</button>
        </div>

        <div id="studentAttendanceControls" class="hidden">
          <input type="date" id="myAttendanceDate" />
          <button id="viewMyAttendanceBtn">Ver mi asistencia</button>
        </div>

        <form id="attendanceForm" class="hidden">
          <table id="attendanceTable">
            <thead><tr><th>#</th><th>Alumno</th><th>Presente</th></tr></thead>
            <tbody></tbody>
          </table>
          <div style="margin-top:12px;">
            <button type="submit">Guardar asistencia</button>
          </div>
        </form>

        <div id="attendanceResult" style="margin-top:12px;color:green;"></div>

        <div id="myAttendanceResult" style="margin-top:12px;color:green;"></div>
      </div>

      <hr />
      <h2>Ítems guardados (demo)</h2>
      <form id="f">
        <input id="text" placeholder="Agregar ítem..." required />
        <button type="submit">Agregar</button>
      </form>
      <ul id="items"></ul>
    </div>

    <script>
      // Helper: token storage and fetch wrapper
      function saveToken(t) { localStorage.setItem('token', t); }
      function getToken() { return localStorage.getItem('token'); }
      function clearToken() { localStorage.removeItem('token'); }

      async function apiFetch(path, opts = {}) {
        opts.headers = opts.headers || {};
        const token = getToken();
        if (token) opts.headers['Authorization'] = 'Bearer ' + token;
        if (opts.body && typeof opts.body === 'object') {
          opts.body = JSON.stringify(opts.body);
          opts.headers['Content-Type'] = 'application/json';
        }
        const res = await fetch(path, opts);
        return res;
      }

      // Auth logic
      async function setUIForUser(userInfo) {
        if (!userInfo) {
          document.getElementById('meUser').textContent = '';
          document.getElementById('meRole').textContent = '';
          document.getElementById('userInfo').classList.add('hidden');
          document.getElementById('logoutBtn').classList.add('hidden');
          document.getElementById('loginBtn').classList.remove('hidden');
          document.getElementById('management').classList.add('hidden');
          document.getElementById('attendanceSection').classList.add('hidden');
          document.getElementById('studentAttendanceControls').classList.add('hidden');
          document.getElementById('teacherAttendanceControls').classList.add('hidden');
          document.getElementById('attendanceForm').classList.add('hidden');
          document.getElementById('status').textContent = 'No autenticado';
          return;
        }

        document.getElementById('meUser').textContent = userInfo.username || 'usuario';
        document.getElementById('meRole').textContent = userInfo.role;
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('attendanceSection').classList.remove('hidden');
        document.getElementById('status').textContent = 'Autenticado como ' + userInfo.role;

        if (['admin','teacher'].includes(userInfo.role)) {
          document.getElementById('management').classList.remove('hidden');
          document.getElementById('teacherAttendanceControls').classList.remove('hidden');
          document.getElementById('attendanceForm').classList.remove('hidden');
          document.getElementById('studentAttendanceControls').classList.add('hidden');
          // load lists
          await loadStudents();
          await loadCourses();
        } else if (userInfo.role === 'student') {
          document.getElementById('management').classList.add('hidden');
          document.getElementById('teacherAttendanceControls').classList.add('hidden');
          document.getElementById('attendanceForm').classList.add('hidden');
          document.getElementById('studentAttendanceControls').classList.remove('hidden');
        }
      }

      // Try to parse JWT to extract role & username (no validation)
      function parseJwt(token) {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload;
        } catch (e) { return null; }
      }

      // On load, check token
      (function initAuth(){
        const token = getToken();
        if (!token) { setUIForUser(null); return; }
        const payload = parseJwt(token);
        if (!payload) { clearToken(); setUIForUser(null); return; }
        // payload contains role and maybe student_id. No username in payload; deliver username via login response normally.
        // We'll store last known username in localStorage if present
        const username = localStorage.getItem('me_username') || payload.uid || 'usuario';
        setUIForUser({ username, role: payload.role, student_id: payload.student_id });
      })();

      document.getElementById('loginBtn').addEventListener('click', async ()=>{
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        if (!username || !password) return alert('usuario y contraseña requeridos');
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ username, password })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({error:'error'}));
          return alert('Error login: ' + (err.error || res.statusText));
        }
        const data = await res.json();
        saveToken(data.token);
        localStorage.setItem('me_username', username);
        await setUIForUser({ username, role: data.role, student_id: data.student_id });
      });

      document.getElementById('logoutBtn').addEventListener('click', ()=>{
        clearToken();
        localStorage.removeItem('me_username');
        setUIForUser(null);
      });

      /* -----------------------
         Items (same as before)
         ----------------------- */
      async function loadItems() {
        try {
          const res = await fetch('/api/items');
          const items = await res.json();
          const ul = document.getElementById('items');
          ul.innerHTML = items.map(it => `<li>#${it.id} — ${it.text}</li>`).join('') || '<li>No hay items</li>';
        } catch (err) {
          document.getElementById('items').innerHTML = '<li>Error al cargar items</li>';
        }
      }
      document.getElementById('f').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = document.getElementById('text').value.trim();
        if(!text) return;
        await fetch('/api/items',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        document.getElementById('text').value='';
        await loadItems();
      });
      loadItems();

      /* -----------------------
         Students / Courses (for admin/teacher)
         ----------------------- */
      async function loadStudents() {
        try {
          const res = await apiFetch('/api/students');
          if (!res.ok) return console.warn('no students');
          const list = await res.json();
          document.getElementById('studentsList').innerHTML = '<h4>Alumnos</h4>' + list.map(s => `<div>#${s.id} - ${s.name}</div>`).join('');
          return list;
        } catch (e) { console.error(e); }
      }
      async function loadCourses() {
        try {
          const res = await apiFetch('/api/courses');
          if (!res.ok) return console.warn('no courses');
          const list = await res.json();
          document.getElementById('coursesList').innerHTML = '<h4>Cursos</h4>' + list.map(c => `<div>#${c.id} - ${c.name}</div>`).join('');
          const sel = document.getElementById('selectCourse');
          sel.innerHTML = list.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
          return list;
        } catch (e) { console.error(e); }
      }

      document.getElementById('addStudentBtn').addEventListener('click', async ()=>{
        const name = document.getElementById('studentName').value.trim();
        if(!name) return alert('Nombre requerido');
        const res = await apiFetch('/api/students', { method: 'POST', body: { name } });
        if (!res.ok) { const t = await res.text(); return alert('Error: '+t); }
        document.getElementById('studentName').value='';
        await loadStudents();
      });

      document.getElementById('addCourseBtn').addEventListener('click', async ()=>{
        const name = document.getElementById('courseName').value.trim();
        if(!name) return alert('Nombre requerido');
        const res = await apiFetch('/api/courses', { method: 'POST', body: { name } });
        if (!res.ok) { const t = await res.text(); return alert('Error: '+t); }
        document.getElementById('courseName').value='';
        await loadCourses();
      });

      /* -----------------------
         Attendance (teacher/admin)
         ----------------------- */

      document.getElementById('loadStudentsBtn').addEventListener('click', async ()=>{
        const date = document.getElementById('attendanceDate').value;
        const courseId = document.getElementById('selectCourse').value;
        if(!courseId) return alert('Seleccioná un curso');
        if(!date) return alert('Seleccioná una fecha');

        const students = await loadStudents();
        const tbody = document.querySelector('#attendanceTable tbody');
        tbody.innerHTML = students.map(s => `
          <tr>
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td><input type="checkbox" data-student-id="${s.id}" checked /></td>
          </tr>
        `).join('');

        // Try to load existing attendance
        try {
          const res = await apiFetch(`/api/attendance?course_id=${courseId}&date=${date}`);
          if (res.ok) {
            const records = await res.json();
            const map = new Map(records.map(r => [r.student_id, r.present]));
            document.querySelectorAll('#attendanceTable tbody input[type=checkbox]').forEach(cb => {
              const sid = Number(cb.getAttribute('data-student-id'));
              if (map.has(sid)) cb.checked = map.get(sid);
            });
          }
        } catch (err) {
          console.warn('No previous attendance or error', err);
        }
      });

      document.getElementById('attendanceForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const date = document.getElementById('attendanceDate').value;
        const courseId = Number(document.getElementById('selectCourse').value);
        if(!courseId || !date) return alert('Fecha y curso requeridos');

        const records = Array.from(document.querySelectorAll('#attendanceTable tbody input[type=checkbox]')).map(cb => ({
          student_id: Number(cb.getAttribute('data-student-id')),
          present: cb.checked
        }));

        const res = await apiFetch('/api/attendance', {
          method: 'POST',
          body: { course_id: courseId, date, records }
        });
        if (res.ok) {
          document.getElementById('attendanceResult').textContent = 'Asistencia guardada correctamente.';
          setTimeout(()=> document.getElementById('attendanceResult').textContent = '', 3000);
        } else {
          const txt = await res.text();
          alert('Error al guardar: '+txt);
        }
      });

      /* -----------------------
         Attendance (student view)
         ----------------------- */
      document.getElementById('viewMyAttendanceBtn').addEventListener('click', async ()=>{
        const date = document.getElementById('myAttendanceDate').value;
        if (!date) return alert('Seleccioná una fecha');
        const res = await apiFetch(`/api/attendance/self?date=${date}`);
        if (!res.ok) {
          const t = await res.text();
          return alert('Error: '+t);
        }
        const rows = await res.json();
        if (rows.length === 0) {
          document.getElementById('myAttendanceResult').textContent = 'No hay registro para esa fecha';
        } else {
          document.getElementById('myAttendanceResult').textContent = rows.map(r => `${r.course_name}: ${r.present ? 'Presente' : 'Ausente'}`).join(' | ');
        }
      });

    </script>
  </body>
</html>